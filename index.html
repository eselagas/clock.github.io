<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://flow.operacdn.com/ext/v1/img/favicon_64_4b10e4fdb7.webp">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Comic+Sans+MS&family=Palatino&family=Lucida+Sans&family=Calibri&family=Open+Sans&family=Oswald&family=Montserrat&family=Lato&family=Ubuntu&family=Merriweather&family=Nunito&family=Raleway&family=Droid+Sans&family=Playfair+Display&family=Fira+Sans&family=Noto+Sans&family=PT+Sans&family=Quicksand&family=Inconsolata&family=Avenir&family=Proxima+Nova&display=swap" rel="stylesheet">
  <link rel="preload" href="https://raw.githubusercontent.com/eselagas/main/main/ebf%20editor/img/add_new_account.jpg" as="image">
  <title>New Document - EBF Editor</title>
</head>
<style>
	:root {
	    /* Primary Theme Colors */
	    --primary-color: #6200ea;
	    --primary-dark: #3700b3;
	    --primary-light: #f0e7fe;
	    
	    /* Background Colors */
	    --bg-white: #fff;
	    --bg-light: #f8f9fa;
	    --bg-lighter: #f0f0f0;
	    --bg-toolbar: rgba(248, 248, 248, 0.621);
	    
	    /* Text Colors */
	    --text-primary: #333;
	    --text-secondary: #666;
	    --text-white: #fff;
	    --text-error: #f00;
	    
	    /* Border Colors */
	    --border-color: #ccc;
	    --border-primary: #6200ea;
	    
	    /* Shadow Colors */
	    --shadow-light: rgba(0, 0, 0, 0.1);
	    --shadow-medium: rgba(0, 0, 0, 0.2);
	    --shadow-focus: rgba(172, 113, 255, 0.75);
	    
	    /* Status Colors */
	    --success-color: #4CAF50;
	    --info-color: #03A9F4;
	    --danger-color: #dc3545;
	    --danger-dark: #c82333;
	    
	    /* Overlay Colors */
	    --offline-bg: #000040;
	}
	
	body {
	    font-family: 'Roboto', sans-serif;
	    margin: 0;
	    padding: 0;
	    background: var(--bg-light);
	    background-attachment: fixed;
	    color: var(--text-primary); /* Text color for elements not styled */
	    align-items: center;
	}
	
	* {
		outline: none;
	}

	.toolbar {
	    display: flex;
	    gap: 10px;
	    padding: 10px;
	    background: var(--bg-toolbar);
    	box-shadow: 0 4px 6px var(--shadow-light);
	    position: fixed;
	    width: 90%;
	    bottom: 20px;
	    left: 5%;
	    border-radius: 12px;
	    z-index: 10;
	    justify-content: center;
	    animation: fadeIn 1s;
	}

	.toolbar button, .toolbar select {
	    padding: 8px 12px;
	    cursor: pointer;
	    border: none;
	    border-radius: 50px;
	    font-weight: bold;
	    transition: background 0.3s ease, transform 0.3s ease;
	    background: var(--primary-color);
    	color: var(--text-white);
	}

	.toolbar button:hover, .toolbar select:hover {
	    background: var(--primary-dark);
	    transform: translateY(-2px);
	}
	
	.toolbar button.select {
		background: var(--primary-dark);
		box-shadow: 0 0 12px 2px var(--shadow-focus);
	}

	@keyframes fadeOutBoxShadow {
	    to {
	        box-shadow: none;
	    }
	}

	.toolbar button:focus, .toolbar select:focus {
	    box-shadow: 0 0 5px 2px var(--shadow-focus);
	}

	.toolbar button:focus:not(:hover), .toolbar select:focus:not(:hover) {
	    animation: fadeOutBoxShadow 2s forwards;
	}


	#editor {
	    position: fixed;
	    width: calc(100% - 60px);
	    height: calc(100vh - 190px);
	    top: 53px;
	    border: none;
	    padding: 20px;
	    margin: 10px;
	    outline: none;
	    overflow-y: auto;
	    scroll-behavior: smooth;
	    font-size: 14px;
	    background: none;
	    border-radius: 8px;
	    z-index: 5;
	}

	#editorBG {
	    position: fixed;
	    top: 53px;
	    padding: 20px;
	    margin: 10px;
	    width: calc(100% - 60px);
	    height: calc(100vh - 190px);
	    background: var(--bg-white);
    	box-shadow: 0 0 10px var(--shadow-light);
	    border-radius: 8px;
	}

	#editor::-webkit-scrollbar {
	    display: none;
	}

	#settingsModal::-webkit-scrollbar {
		display: none;
	}

	.toolbar .save {
	    position: absolute;
	    background: var(--success-color);
	    left: 12px;
	}

	.toolbar .open {
	    position: absolute;
	    background: var(--info-color);
	    right: 12px;
	}

	.toolbar .save:hover{
	    transform: translateX(8px)

	}
	.toolbar .open:hover {
	    transform: translateX(-8px);
	}

	.hide {
	    display: none;
	}

	.modal-overlay {
	    display: none;
	    position: fixed;
	    top: 0;
	    left: 0;
	    width: 100%;
	    height: 100%;
	    background: rgba(0, 0, 0, 0.7);
	    z-index: 19;
	    animation: fadeIn 0.3s ease;
	}

	.modal {
	    position: fixed;
	    top: 50%;
	    left: 50%;
	    transform: translate(-50%, -50%);
	    padding: 30px;
	    border-radius: 12px;
	    background: var(--bg-white);
    	box-shadow: 0 4px 20px var(--shadow-medium);
	    z-index: 20;
	    min-width: 300px;
	    animation: slideIn 0.3s ease;
	}

	.modal h2 {
	    margin-top: 0;
	    margin-bottom: 12px;
	    color: var(--text-primary);
	}

	.modal input {
	    position: relative;
	    border: 2px solid var(--border-primary);
	    width: 90%;
	    padding: 10px;
	    margin: 10px auto;
	    border-radius: 6px;
	    outline: none;
	    margin-bottom: 20px;
	}
	
	.modal .color-picker {
		width: 100%;
	}

	.modal button {
	    padding: 10px 20px;
	    margin: 5px;
	    border: none;
	    border-radius: 6px;
	    background: var(--primary-color);
    	color: var(--text-white);
	    cursor: pointer;
	    transition: background 0.3s ease;
	}

	.modal button:hover {
	    background: var(--primary-dark);
	}

	.modal button.cancel {
	    background: var(--danger-color);
	}

	.modal button.cancel:hover {
	    background: var(--danger-dark);
	}

	.saved-files-list {
	    max-height: 300px;
	    overflow-y: auto;
	    margin: 10px 0;
	}

	.saved-file-item {
	    padding: 10px;
	    margin: 5px 0;
	    background: var(--bg-light);
	    border-radius: 6px;
	    cursor: pointer;
	    transition: background 0.2s ease;
	}

	.saved-file-item:hover {
	    background: var(--bg-lighter);
	}

	@keyframes fadeIn {
	    from { opacity: 0; }
	    to { opacity: 1; }
	}

	@keyframes slideIn {
	    from {
	        transform: translate(-50%, -60%);
	        opacity: 0;
	    }
	    to {
	        transform: translate(-50%, -50%);
	        opacity: 1;
	    }
	}

	.save-options {
	    display: flex;
	    flex-direction: column;
	    gap: 10px;
	    margin: 15px 0;
	}
	
	.saved-files-list::-webkit-scrollbar {
		display: none;
	}

	.save-option {
	    padding: 15px;
	    border: 2px solid var(--border-primary);
	    border-radius: 8px;
	    cursor: pointer;
	    transition: all 0.3s ease;
	}

	.save-option:hover {
	    background: var(--primary-light);
	    transform: scale(1.03);
	}

	.save-option.selected {
	    background: var(--primary-color);
    	color: var(--text-white);
	}
	
	.save-option:focus {
		 background: var(--primary-color);
		 color: var(--text-white);
	}

	.loading-overlay {
	    position: fixed;
	    top: 0;
	    left: 0;
	    width: 100%;
	    height: 100%;
	    background-color: rgba(0, 0, 0, 0.342);
	    display: flex;
	    justify-content: center;
	    align-items: center;
	    z-index: 101;
	}

	.spinner {
	    border: none;
	    border-radius: 5px;
	    background: var(--bg-white);
	    padding: 20px;
	}

	.loading-spinner {
	    border: 4px solid #bfbfbf;
    	border-top: 4px solid var(--border-primary);
	    border-radius: 50%;
	    width: 50px;
	    height: 50px;
	    animation: spin 1s linear infinite;
	}
	
	#top-menu {
	    display: flex;
	    justify-content: center;
	    align-items: center;
	    background: var(--bg-lighter);
	    border-bottom: 2px solid var(--border-color);
	    box-shadow: 0 2px 4px var(--shadow-light);
	    padding: 14px 20px;
	    position: fixed;
	    top: 0;
	    width: 100%;
	    box-sizing: border-box;
	}

	#username_container {
	    display: flex;
	    align-items: center;
	    position: absolute;
	    left: 20px;
	}

	.userIcon {
	    width: 30px;
	    height: 30px;
	    border-radius: 16%;
	    margin-right: 10px;
	    cursor: pointer;
	    transition: transform 0.2s ease;
	    background-color: #b3b3b3;
	    display: block;
	}

	#username {
	    font-weight: bold;
	    font-size: 16px;
	    color: var(--text-primary);
	}

	#doc-title {
	    font-size: 19px;
	    font-weight: bold;
	    color: var(--text-secondary);
	}

	#settings {
	    background: none;
	    border: none;
	    font-size: 22px;
	    cursor: pointer;
	    margin-bottom: 2px;
	    padding: 0px;
	    transition: transform 0.2s ease;
	    position: absolute;
	    right: 16px;
	}

	#settings:hover {
	    transform: scale(1.2);
	}
	
	#wifi-status {
	    position: fixed;
	    top: 0;
	    left: 0;
	    width: 100%;
	    background: var(--offline-bg);
    	color: var(--text-error);
    	box-shadow: 0 2px 5px var(--shadow-medium);
	    text-align: center;
	    padding: 10px;
	    font-family: 'Roboto', sans-serif;
	    z-index: 20;
	}

	#wifi-status h4 {
		margin: 0;
	    display: inline-block;
	}

	.close {
	    background: none;
	    border: none;
	    margin-left: 5px;
	    cursor: pointer;
	    color: var(--text-error);
	    top: 1.5px;
	    font-size: 30px;
    	position: fixed;
	}

	.close:hover {
	    color: var(--danger-dark);
	}
	
	#ccm {
	    position: absolute;
	    display: none;
	    border-radius: 6px;
	    background: var(--bg-white);
    	border: 1px solid var(--border-color);
    	box-shadow: 2px 2px 5px var(--shadow-medium);
	    z-index: 100;
	}
	#ccm ul {
	    list-style: none;
	    margin: 0;
	    padding: 0;
	}
	#ccm ul li {
	    padding: 8px 12px;
	    cursor: pointer;
	    border-radius: 6px;
	}
	#ccm ul li:hover {
	    background: var(--bg-lighter);
	}

	#settingsModal {
		overflow-y: auto;
		max-height: 550px;
		display: none; 
		max-width: 500px;
	}

	@keyframes spin {
	    0% { transform: rotate(0deg); }
	    100% { transform: rotate(360deg); }
	}
	
	.color-category {
	    cursor: pointer;
	}

	.color-category .arrow {
	    float: right;
	}

	.dropdown-content {
	    display: none;
	}

	.color-category.active .dropdown-content {
	    display: block;
	}

	.resizable {
	    position: relative;
	    display: inline-block;
	    transition: transform 0.3s ease;
	    transform-origin: center center;
	    max-width: fit-content;
	    max-height: fit-content;
	}

	.resizable img {
	    display: block;
	    border-radius: 8px;
	}

	.resize-handle {
	    position: absolute;
	    width: 10px;
	    height: 10px;
	    background: var(--bg-white);
    	border: 2px solid var(--border-primary);
	    border-radius: 50%;
	    transition: transform 0.3s ease;
	}

	.resize-handle:hover {
	  transform: scale(1.4);
	}

	.resize-handle.top-left {
	    top: -5px;
	    left: -5px;
	    cursor: nwse-resize;
	}

	.resize-handle.top-right {
	    top: -5px;
	    right: -5px;
	    cursor: nesw-resize;
	}

	.resize-handle.bottom-left {
	    bottom: -5px;
	    left: -5px;
	    cursor: nesw-resize;
	}

	.resize-handle.bottom-right {
	    bottom: -5px;
	    right: -5px;
	    cursor: nwse-resize;
	}

	table, th, td {
	    border-collapse: collapse;
	    padding: 10px;
	    border: 1px solid var(--border-color);
    	background: var(--bg-white);
    	box-shadow: 0 0 5px var(--shadow-light);
	    transition: box-shadow 0.3s ease;
	    border-radius: 2px;
	}

	table:hover, th:hover, td:hover {
	    box-shadow: 0 0 10px var(--shadow-medium);
	}

	#drawingCanvas {
	    z-index: 1;
	    position: fixed;
	    left: 10px;
	    top: 63.5px;
	    border-radius: 8px;
	}

	blockquote {
		margin: 0 0 0 40px;
	}
	
	ul, ol {
		margin: 0px;
	}
	
	.label {
		text-align: center; font-size: 16px;
	}
	
	.delete-icon {
		float: right;
	    position: relative;
	    bottom: 2px;
	    transition: transform 0.2s ease;
	}
	
	.delete-icon:hover {
		transform: scale(1.16);
	}
	
	.color-picker {
	    height: 40px;
	    padding: 2px;
	    border: 2px solid var(--border-color);
	    border-radius: 6px;
	    cursor: pointer;
	}

	.color-picker::-webkit-color-swatch {
	    border: none;
	    border-radius: 8px;
	    padding: 0;
	}

	.color-picker::-webkit-color-swatch-wrapper {
	    border: none;
	    border-radius: 4px;
	    padding: 0;
	}
	
	.p1 {
		word-wrap: break-word;
		width: 360px;
		margin: 5px 0;
	}
	
	.p2 {
		color: #828282;
		font-size: 15px;
	}
	
	.divide {
		width: 100%;
		height: 1px;
		background-color: #929292;
		margin: 42px 0;
	}
</style>
<body>

	<div id="loverlay" class="loading-overlay" style="display: none;">
	    <div class="spinner">
	        <div class="loading-spinner"></div>
	    </div>
	</div>

	<div id="wifi-status" style="display: none;">
		<h4>You are currently offline. Some features may not work as expected.</h4>
		<button class="close" onclick="get('wifi-status').style.display = 'none';">&times;</button>
	</div>

	<div id="sign_in" class="modal-overlay">
		<div class="modal" style="display: flex; flex-direction: column;">
			<h2 style="text-align: center; margin-top: 0px; margin-bottom: 25px;">Sign In</h2>
			<label for="username_val" class="label">Enter Username</label>
			<input type="text" id="username_val">
			<label for="password_val" class="label">Enter Password</label>
			<input type="password" id="password_val">
			<button onclick="signIn()">Sign In</button>
			<button class="cancel" onclick="get('sign_in').style.display = 'none';">Cancel</button>
		</div>
	</div>

	<div id="top-menu">
		<div id="username_container">
			<img alt="" class="userIcon" id="signIco" onclick="promptSignIn()">
			<div id="username"></div>
		</div>
		<div id="doc-title" onclick="set_name_from_title();">Untitled Document</div>
		<button id="settings" title="Open Settings">⚙️</div>
	</div>

	<div id="ccm" style="display: none;">
	    <ul>
	        <li onclick="unordered_list()">Dot point list</li>
	        <li onclick="ordered_list()">Numbered list</li>
	    </ul>
	</div>

	<div id="settingsModal" class="modal" title="Settings">
	    <h2>Settings</h2>

	    <!-- Theme Selection -->
	    <div name="Presets" style="margin-bottom: 30px;">
	        <h3 style="margin-bottom: 10px;">Theme</h3>
	        <div class="save-options">
	        	<div class="save-option" onclick="applyTheme('default')">
	                <strong>Default Theme</strong>
	                <p class="p1">Default color scheme</p>
	            </div>
	            <div class="save-option" onclick="applyTheme('light')">
	                <strong>Light Theme</strong>
	                <p class="p1">Light Blue color scheme</p>
	            </div>
	            <div class="save-option" onclick="applyTheme('dark')">
	                <strong>Dark Theme</strong>
	                <p class="p1">Dark color scheme for low-light environments</p>
	            </div>
	            <div class="save-option" onclick="applyTheme('vibrant')">
	                <strong>Vibrant</strong>
	                <p class="p1">Add vibrant colors to your editor</p>
	            </div>
	            <div class="save-option" onclick="applyTheme('tropical')">
	                <strong>Tropical</strong>
	                <p class="p1">Make your editor tropical</p>
	            </div>
	            <div class="save-option" onclick="applyTheme('rainbow')">
	                <strong>Rainbow</strong>
	                <p class="p1">Add complex, colorful gradients to your EBF Editor</p>
	            </div>
	            <div class="save-option" onclick="applyTheme('dark_rainbow')">
	                <strong>Dark Rainbow</strong>
	                <p class="p1">A version of the Rainbow theme with darker colors</p>
	            </div>
	        </div>
	    </div>

	    <!-- Custom Colors -->
	    <div name="Custom Options" style="margin-bottom: 20px;">
	        <h3 style="margin-bottom: 10px;">Customize Colors</h3>

	        <!-- Primary Colors -->
	        <div class="color-category">
	            <h4 onclick="toggleDropdown(this)">Primary Colors <span class="arrow">▼</span></h4>
	            <div class="dropdown-content">
	                <div>
	                    <label for="primaryColor">Main Button</label>
	                    <input type="color" id="primaryColor" class="color-picker">
	                </div>
	                <div>
	                    <label for="primaryDark">Button Hover</label>
	                    <input type="color" id="primaryDark" class="color-picker">
	                </div>
	                <div>
	                    <label for="primaryLight">Primary Light</label>
	                    <input type="color" id="primaryLight" class="color-picker">
	                </div>
	            </div>
	        </div>

	        <!-- Background Colors -->
	        <div class="color-category">
	            <h4 onclick="toggleDropdown(this)">Background Colors <span class="arrow">▼</span></h4>
	            <div class="dropdown-content">
	                <div>
	                    <label for="bgWhite">Main Background</label>
	                    <input type="color" id="bgWhite" class="color-picker">
	                </div>
	                <div>
	                    <label for="bgLight">Light Background</label>
	                    <input type="color" id="bgLight" class="color-picker">
	                </div>
	                <div>
	                    <label for="bgLighter">Lighter Background</label>
	                    <input type="color" id="bgLighter" class="color-picker">
	                </div>
	                <div>
	                    <label for="bgToolbar">Toolbar Background</label>
	                    <input type="color" id="bgToolbar" class="color-picker">
	                </div>
	            </div>
	        </div>

	        <!-- Text Colors -->
	        <div class="color-category">
	            <h4 onclick="toggleDropdown(this)">Text Colors <span class="arrow">▼</span></h4>
	            <div class="dropdown-content">
	                <div>
	                    <label for="textPrimary">Header Color</label>
	                    <input type="color" id="textPrimary" class="color-picker">
	                </div>
	                <div>
	                    <label for="textWhite">Main Text</label>
	                    <input type="color" id="textWhite" class="color-picker">
	                </div>
	                <div>
	                    <label for="textSecondary">Secondary Text</label>
	                    <input type="color" id="textSecondary" class="color-picker">
	                </div>
	                <div>
	                    <label for="textError">Error Text</label>
	                    <input type="color" id="textError" class="color-picker">
	                </div>
	            </div>
	        </div>

	        <!-- Border Colors -->
	        <div class="color-category">
	            <h4 onclick="toggleDropdown(this)">Border Colors <span class="arrow">▼</span></h4>
	            <div class="dropdown-content">
	                <div>
	                    <label for="borderColor">Border Color</label>
	                    <input type="color" id="borderColor" class="color-picker">
	                </div>
	                <div>
	                    <label for="borderPrimary">Primary Border</label>
	                    <input type="color" id="borderPrimary" class="color-picker">
	                </div>
	            </div>
	        </div>

	        <!-- Shadow Colors -->
	        <div class="color-category">
	            <h4 onclick="toggleDropdown(this)">Shadow Colors <span class="arrow">▼</span></h4>
	            <div class="dropdown-content">
	                <div>
	                    <label for="shadowLight">Element Shadow</label>
	                    <input type="color" id="shadowLight" class="color-picker">
	                </div>
	                <div>
	                    <label for="shadowMedium">Popup Shadow</label>
	                    <input type="color" id="shadowMedium" class="color-picker">
	                </div>
	                <div>
	                    <label for="shadowFocus">Focus Shadow</label>
	                    <input type="color" id="shadowFocus" class="color-picker">
	                </div>
	            </div>
	        </div>

	        <!-- Status Colors -->
	        <div class="color-category">
	            <h4 onclick="toggleDropdown(this)">Status Colors <span class="arrow">▼</span></h4>
	            <div class="dropdown-content">
	                <div>
	                    <label for="successColor">Save Color</label>
	                    <input type="color" id="successColor" class="color-picker">
	                </div>
	                <div>
	                    <label for="infoColor">Open Color</label>
	                    <input type="color" id="infoColor" class="color-picker">
	                </div>
	                <div>
	                    <label for="dangerColor">Danger Color</label>
	                    <input type="color" id="dangerColor" class="color-picker">
	                </div>
	                <div>
	                    <label for="dangerDark">Dark Danger Color</label>
	                    <input type="color" id="dangerDark" class="color-picker">
	                </div>
	                <div>
	                    <label for="offlineBg">Offline Background</label>
	                    <input type="color" id="offlineBg" class="color-picker">
	                </div>
	            </div>
	        </div>
	        
	        <div class="divide"></div>
	        
	        <div id="version">
	        	<h3>Version</h3>
	        	<p class="p2"> - 14.2.3</p>
	        </div>

	        <div style="text-align: center;">
	            <button onclick="resetTheme()" class="cancel" title="Revert back to saved defaults">Reset</button>
	            <button onclick="hideSettingsModal()" title="Close and save">Close</button>
	        </div>
	    </div>
	</div>

	<div id="edContainer">
		<div id="editorBG" contenteditable="false"></div>
		<div id="editor" contenteditable="true" role="textbox" aria-label="Content editor"></div>
	</div>

	<div class="toolbar" id="textToolbar" role="toolbar" aria-label="Text formatting tools" title="Text formatting tools">
	    <button class="save" id="save" aria-label="Save the document with options" title="Save the document with options">Save</button>
	    <button onclick="execCmd('bold')" aria-label="Make text bold" title="Bold" id="bold"><b>B</b></button>
	    <button onclick="execCmd('italic')" aria-label="Make text italic" title="Italic" id="italic"><i>I</i></button>
	    <button onclick="execCmd('underline')" aria-label="Make text underlined" title="Underline" id="underline"><u>U</u></button>
	    <select id="fontSelect" onchange="changeFont(this.value)" aria-label="Select font" title="Select font">
	        <!-- Options added dynamically -->
	    </select>
	    <button onclick="insertTable()" aria-label="Insert table" title="Insert a table">Table</button>
	    <button onclick="decFontSize()" aria-label="Decrease font size" title="Decrease font size">A-</button>
	    <button onclick="incFontSize()" aria-label="Increase font size" title="Increase font size">A+</button>
	    <button onclick="toggleDrawingToolbar()" aria-label="Toggle drawing tools" title="Toggle drawing tools">Draw</button>
	    <select id="alignSelect" onchange="changeAlignment(this.value)" aria-label="Text alignment" title="Change text alignment">
	        <option value="">Align</option>
	        <option value="justifyLeft">Left</option>
	        <option value="justifyCenter">Center</option>
	        <option value="justifyRight">Right</option>
	    </select>
	    <button class="open" id="open" aria-label="Open a document" title="Open a document">Open</button>
	</div>
	  
	<div class="toolbar hide" id="tableToolbar" role="toolbar" aria-label="Table editing tools" title="Table editing tools">
	    <button onclick="addRow()">Add Row</button>
	    <button onclick="addColumn()">Add Column</button>
	    <button onclick="deleteRow()">Delete Row</button>
	    <button onclick="deleteColumn()">Delete Column</button>
	    <button onclick="mergeCells()">Merge Cells</button>
	    <button onclick="splitCell()">Split Cell</button>
	    <select onchange="setCellType(this.value)" name="Cell Type" title="Cell Type">
	        <option value="td">Cell</option>
	        <option value="th">Header</option>
	    </select>
	    <select onchange="setAlignment(this.value)" name="Align" title="Align">
	        <option value="left">Left</option>
	        <option value="center">Center</option>
	        <option value="right">Right</option>
	    </select>
	    <button onclick="toggleTextToolbar()">Exit Table Mode</button>
	</div>

	<div class="toolbar hide" id="drawingToolbar" role="toolbar" aria-label="Drawing tools" title="Drawing tools">
	    <button onclick="selectPenColor()" aria-label="Select pen tool" title="Select pen tool">Pen</button>
	    <button onclick="selectHighlighter()" aria-label="Select highlighter tool" title="Select highlighter tool">Highlighter</button>
	    <button onclick="selectEraser()" aria-label="Select eraser tool" title="Select eraser tool">Eraser</button>
	    <input type="color" id="penColor" value="#000000" aria-label="Select color" title="Select color">
	    <button onclick="setInkThickness(1)" aria-label="Set thin line width" title="Set thin line width">Thin</button>
	    <button onclick="setInkThickness(5)" aria-label="Set medium line width" title="Set medium line width">Medium</button>
	    <button onclick="setInkThickness(10)" aria-label="Set thick line width" title="Set thick line width">Thick</button>
	    <button onclick="saveAndHideDrawingToolbar()" aria-label="Save drawing and exit" title="Save drawing and exit">Done</button>
	</div>

	<div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true">
	    <div id="passwordModal" class="modal" title="Enter Password">
	        <h2 id="passwordModalTitle">Enter Password</h2>
	        <input type="password" id="passwordInput" title="Type your password here" placeholder="Enter password" autocomplete="off">
	        <div style="text-align: center;">
	            <button onclick="hideModal()" class="cancel">Cancel</button>
	            <button onclick="set_as_password()">Confirm</button>
	        </div>
	    </div>
	    
	    <div id="openFileModal" class="modal" style="display: none;" title="Open File popup">
	        <h2>Open File</h2>
	        <div class="saved-files-list" id="savedFilesList"></div>
	        <div style="text-align: center; margin-top: 15px;">
	            <button onclick="get('fileInput').click()" title="Open a file from your computer">Open Local File</button>
	            <button onclick="hideModal()" class="cancel" title="Cancel">Cancel</button>
	        </div>
	    </div>
	</div>

	<div id="saveOptionsModal" class="modal" style="display: none;" title="Save Option">
	    <h2>Save Options</h2>
	    <div class="save-options">
	        <div class="save-option" onclick="selectSaveOption('encrypted')">
	            <strong>Save with Encryption</strong>
	            <p class="p1">Secure your document with password protection</p>
	        </div>
	        <div class="save-option" onclick="selectSaveOption('unencrypted')">
	            <strong>Save without Encryption</strong>
	            <p class="p1">Save document without password protection</p>
	        </div>
	    </div>
	    <div class="save-options">
	        <div class="save-option" id="gh" onclick="selectSaveOption('github')">
	            <strong>Save to Cloud</strong>
	            <p class="p1">Store document in GitHub</p>
	        </div>
	        <div class="save-option" onclick="selectSaveOption('download')">
	            <strong>Save as File</strong>
	            <p class="p1">Download document to your computer</p>
	        </div>
	    </div>
	    <div style="text-align: right; margin-top: 15px;">
	        <button onclick="hideModal()" class="cancel">Cancel</button>
	        <button onclick="init_save()">Continue</button>
	    </div>
	</div>

	<div id="prompt" class="modal" style="display: none; flex-direction: column;" title="Prompt">
	    <h2 id="title"></h2>
	    <input type="text" id="p_text" autocomplete="off">
	    <button id="conf" title="Set">Confirm</button>
	</div>

	<div id="alert" class="modal" style="display: none;" title="Alert">
		<h3 id="alert-msg"></h3>
		<button id="ok">OK</button>
	</div>
	  
	<canvas id="drawingCanvas" role="img" aria-label="Drawing canvas" title="Drawing canvas"></canvas>
	<input type="file" id="fileInput" accept=".ebf" style="display:none">

<script>
	let fontSize = 14, lastFont = "Roboto", lastAlignment = 'justifyLeft', selectedImage = null, fileName = null, isDrawing = false, savedDrawingData;
	const fonts = {
            online: [
                "Roboto", "Arial", "Courier New", "Georgia", "Times New Roman", "Verdana", 
                "Comic Sans MS", "Trebuchet MS", "Tahoma", "Garamond", 
                "Palatino", "Lucida Sans", "Calibri", "Open Sans", "Oswald", "Montserrat",
                "Lato", "Ubuntu", "Merriweather", "Nunito", "Raleway", "Droid Sans",
                "Playfair Display", "Fira Sans", "Noto Sans", "PT Sans", "Quicksand", 
                "Inconsolata", "Avenir", "Proxima Nova"
            ],
            offline: [
                "Roboto", "Courier New", "Georgia", "Times New Roman", "Verdana", 
                "Trebuchet MS", "Tahoma", "Garamond"
            ]
        };
        
    	let isConnected = navigator.onLine;
    	if (!isConnected) {get('wifi-status').style.display = 'block'; console.warn('No internet connection.');}
    	const boldButton = get('bold');
	    const italicButton = get('italic');
	    const underlineButton = get('underline');
	    
		/* Text button emphasis */
		function selectUpdate() {
		    const selection = window.getSelection();
		    if (!selection.rangeCount) return;

		    const range = selection.getRangeAt(0);
		    const element = range.startContainer.parentElement;

		    const computedStyle = window.getComputedStyle(element);
		    updateButtonState(boldButton, computedStyle.fontWeight === '700');
		    updateButtonState(italicButton, computedStyle.fontStyle === 'italic');
		    updateButtonState(underlineButton, computedStyle.textDecoration.includes('underline'));
		    
		    /* Handling <font> tags */
		    const fontFace = element.tagName === 'font' ? element.getAttribute('face') : computedStyle.fontFamily;
		    updateFontDropdown(fontFace);
		}

	function updateButtonState(button, condition) {
	    if (condition) {
	        button.classList.add('select');
	    } else {
	        button.classList.remove('select');
	    }
	}

	function updateFontDropdown(fontFace) {
	    const fontSelect = get('fontSelect');
	    const selectedOption = Array.from(fontSelect.options).find(option => option.value === fontFace);

	    if (selectedOption && fontSelect.value !== fontFace) {
	        fontSelect.value = fontFace;
	    }
	}

	get('editor').addEventListener('mouseup', selectUpdate);

	function updateFontOptions() {
	    const fontSelect = get('fontSelect');
	    fontSelect.innerHTML = "";
	    const availableFonts = isConnected ? fonts.online : fonts.offline;
	    availableFonts.forEach(font => {
	        const option = document.createElement('option');
	        option.value = font;
	        option.textContent = font;
	        fontSelect.appendChild(option);
	    });
	}

	document.addEventListener('DOMContentLoaded', updateFontOptions);

	/* Progress Spinner */
	function showLoadingSpinner() {
	    get('loverlay').style.display = 'flex';
	}

	function endSpinner() {
	    get('loverlay').style.display = 'none';
	}

	function execCmd(command) {document.execCommand(command, false, null);}
	
	function unordered_list() {
		editor.focus();
		document.execCommand('insertUnorderedList', false, null);
	}
	
	function ordered_list() {
		editor.focus();
		document.execCommand('insertOrderedList', false, null);
	}

	document.addEventListener('keydown', function(event) {
	    if (event.key === 'Tab') {
	        event.preventDefault();
	        if (event.shiftKey) {
	            execCmd('outdent');
	        } else if (!event.shiftKey) {
	            execCmd('indent');
	        }
	    }
	});

	let userId;

	function getId() {
	    userId = localStorage.getItem('user_id');
	    get('username').textContent = localStorage.getItem('ebf_username');
	    if (!userId) {
	        return;
	    }
	    return userId;
	}

	getId();
	
	/* Sign in */
	function promptSignIn() {
		get('password_val').innerText = '';
	    get('username_val').innerText = '';
		get('sign_in').style.display = "block";
	}
	
	async function signIn() {
	  showLoadingSpinner();
	    const password = get('password_val').value;
	    const username = get('username_val').value;
	    get('sign_in').style.display = "none";
	    
	    const encodedUsername = btoa(`${username}:${password}`);
	    
	    userId = encodedUsername;
	    localStorage.setItem('user_id', userId);
	    localStorage.setItem('ebf_username', username);
	    get('username').textContent = username;
	    updateImageAttributes();
	    location.reload();
	    endSpinner();
	}
	
	/* Image handling */
	function updateImageAttributes() {
	  const imgElement = get('signIco');
	  const signedIn = {
	    src: "https://raw.githubusercontent.com/eselagas/main/main/ebf%20editor/img/added_account.jpg",
	    alt: "",
	    style: "transform: scale(1.0)"
	  };
	  const altAccount = {
	    src: "https://raw.githubusercontent.com/eselagas/main/main/ebf%20editor/img/add_new_account.jpg",
	    alt: "",
	    title: "Sign in with another account",
	    style: "transform: scale(1.12)"
	  };
	  const signedOut = {
	    src: "https://raw.githubusercontent.com/eselagas/main/main/ebf%20editor/img/add_account.jpg",
	    alt: "",
	    title: "Sign in",
	    style: "transform: scale(1.0)"
	  };
	  
	  if (userId) {
	    Object.assign(imgElement, signedIn);
	  } else {
	    Object.assign(imgElement, signedOut);
	    get('username').textContent = "Unknown User";
	  }

	  imgElement.addEventListener('mouseover', function() {
	  if (userId) {
	    Object.assign(imgElement, altAccount);
	    }
	  });

	  imgElement.addEventListener('mouseout', function() {
	  if (userId) {
	    Object.assign(imgElement, signedIn);
	    }
	  });
	}

	updateImageAttributes();

	
	/* Prompts */
	function prompts(text, placeholder) {
	  return new Promise((resolve, reject) => {
	    const modal = get('prompt');
	    const title = get('title');
	    const input = get('p_text');
	    const confirm = get('conf');

	    if (!modal || !title || !input) {
	      reject(new Error('Required DOM elements not found'));
	      return;
	    }
	    
	    input.value = '';

	    modal.style.display = "flex";
	    title.innerHTML = `${text} <span id="x" style="right: 35px; top: 17px; font-size: 40px;" class="close" title="Cancel">&times;</span>`;
	    input.placeholder = placeholder;
	    
	    const x = get('x');
	    x.addEventListener('click', function() {
	      modal.style.display = "none";
	      reject(new Error('Modal closed.'));
	    });
	    
	    confirm.addEventListener('click', function() {
	      const value = input.value;
	      modal.style.display = "none";
	      resolve(value);
	    });

	    input.onkeyup = (e) => {
	      if (e.key === 'Enter') {
	        const value = input.value;
	        modal.style.display = "none";
	        input.onkeyup = null;
	        resolve(value);
      }
    };
  });
}
	
	/* Alerts */
	function alert(message) {
		const alert = get('alert-msg');
		const modal = get('alert');
		const button = get('ok');
		endSpinner();
		alert.textContent = message;
		modal.style.display = "block";
		button.addEventListener('click', function() {
			modal.style.display = "none";
		})
		modal.onkeyup = (e) => {
	      if (e.key === 'Enter') {
	        modal.style.display = "none";
	        modal.onkeyup = null;
	      }
	    };
	}
	
	async function set_name_from_title() {
		const title = get('doc-title');
        fileName = await prompts('Document Title', title.textContent || 'Untitled Document');
        title.textContent = fileName || 'Untitled Document';
        document.title = `${fileName || 'Untitled Document'} - EBF Editor`;
	}
	
	function changeDocTitle(file) {
		get('doc-title').textContent = file;
        document.title = `${file} - EBF Editor`;
	}
	
	/* Custom menu (ccm) */
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showCCM(e.pageX, e.pageY);
    });

    document.addEventListener('click', function() {
        get('ccm').style.display = 'none';
    });

    function showCCM(x, y) {
	    const menu = get('ccm');
	    menu.style.display = 'block';
	    const screenWidth = window.innerWidth;
	    const screenHeight = window.innerHeight;
	    const menuWidth = menu.offsetWidth;
	    const menuHeight = menu.offsetHeight;

	    x = Math.min(Math.max(0, x), screenWidth - menuWidth);
	    y = Math.min(Math.max(0, y), screenHeight - menuHeight);

	    menu.style.top = `${y}px`;
	    menu.style.left = `${x}px`;
	}

	/* drawingCanvas automatic resize */
	const resizeHandler = () => {
	    const canvas = get('drawingCanvas');
	    canvas.width = window.innerWidth - 20;
	    canvas.height = window.innerHeight - 150;
	};

	window.addEventListener('resize', resizeHandler);
	resizeHandler();


	/* Zoom */
	document.addEventListener('DOMContentLoaded', function() {
	    let currentScale = 1;
	    let initialDistance = 0;

	    function initializePinchToZoom(editor) {
	        function handleTouchStart(event) {
	            if (event.touches.length === 2) {
	                initialDistance = getDistance(event.touches[0], event.touches[1]);
	            }
	        }

	        function handleTouchMove(event) {
	            if (event.touches.length === 2) {
	                event.preventDefault();
	                const newDistance = getDistance(event.touches[0], event.touches[1]);
	                const scaleChange = newDistance / initialDistance;
	                currentScale *= scaleChange;
	                editor.style.transform = `scale(${currentScale})`;
	                initialDistance = newDistance;
	            }
	        }
	        
	        function updateScale(currentScale) {
	    		const newScale = currentScale * 2;
	    		return `scale(${newScale})`;
			}

	        function handleTouchEnd(event) {
	            if (currentScale < 0.2) {
	                currentScale = 0.2;
	            } else if (currentScale > 3) {
	                currentScale = 3;
	            }
	            editor.style.transform = `scale(${currentScale})`;
	            resizeScale.style.transform = eval(currentScale + currentScale);
	        }

	        function getDistance(touch1, touch2) {
	            return Math.hypot(touch2.pageX - touch1.pageX, touch2.pageY - touch1.pageY);
	        }

	        editor.addEventListener('touchstart', handleTouchStart);
	        editor.addEventListener('touchmove', handleTouchMove);
	        editor.addEventListener('touchend', handleTouchEnd);

	        editor.addEventListener('wheel', handleWheelZoom);
	    }

	    function handleWheelZoom(event) {
	        event.preventDefault();
	        const zoomFactor = 0.1;
	        const delta = Math.sign(event.deltaY);
	        currentScale += delta * -zoomFactor;
	        if (currentScale < 0.2) {
	            currentScale = 0.2;
	        } else if (currentScale > 3) {
	            currentScale = 3;
	        }
	        const editor = event.currentTarget;
	        editor.style.transform = `scale(${currentScale})`;
	    }

	    const observer = new MutationObserver((mutations) => {
	        mutations.forEach((mutation) => {
	            if (mutation.addedNodes.length) {
	                mutation.addedNodes.forEach((node) => {
	                    if (node.classList && node.classList.contains('resizable')) {
	                        initializePinchToZoom(node);
	                    }
	                });
	            }
	        });
	    });

	    observer.observe(document.body, { childList: true, subtree: true });
	    
	    document.querySelectorAll('.resizable').forEach((element) => {
	        initializePinchToZoom(element);
	    });
	});

	async function insertTable() {
	    try {
	        const rows = await prompts("Enter the number of rows", "(eg. 2)");
	        const cols = await prompts("Enter the number of columns", "(eg. 3)");
	        
	        if (!rows || !cols || isNaN(rows) || isNaN(cols) || rows < 1 || cols < 1) {
	            throw new Error("Invalid table dimensions");
	        }

	        let tableHtml = '<table role="grid">';
	        for (let i = 0; i < rows; i++) {
	            tableHtml += '<tr role="row">';
	            for (let j = 0; j < cols; j++) {
	                tableHtml += `<td role="gridcell" tabindex="0"><br></td>`;
	            }
	            tableHtml += '</tr>';
	        }
	        tableHtml += '</table>';

	        const editor = get('editor');
	        editor.focus();
	        document.execCommand('insertHTML', false, tableHtml);
	        showToolbar('tableToolbar');
	    } catch (err) {
	        alert('Failed to create table: ' + err.message);
	    }
	}

	/* Keyboard shortcut listeners */
	document.addEventListener('keydown', function(event) {
	  if (event.ctrlKey) {
	    switch (event.key) {
	      case 'b':
	        event.preventDefault();
	        execCmd('bold');
	        get('bold').classList.toggle('select');
	        break;
	      case 'i':
	        event.preventDefault();
	        execCmd('italic');
	        get('italic').classList.toggle('select');
	        break;
	      case 'u':
	        event.preventDefault();
	        execCmd('underline');
	        get('underline').classList.toggle('select');
	        break;
	      case 'L' :
	      	event.preventDefault();
	      	changeAlignment('justifyLeft');
	      	break;
	      case 'C' :
	      	event.preventDefault();
	      	changeAlignment('justifyCenter');
	      	break;
	      case 'R' :
	      	event.preventDefault();
	      	changeAlignment('justifyRight');
	      	break;
	      case 's' :
	      	event.preventDefault();
	      	showSaveOptions();
	      	break;
	      case 'o' :
	      	event.preventDefault();
	      	showOpenFileModal();
	      	break;
      	  case 'q' :
	      	event.preventDefault();
	      	window.open(window.location.href, '_blank');
	      	break;
	    }
	  }
	});
	
	class ThemeManager {
	    constructor() {
	        this.root = document.documentElement;
	        this.def = {
	            'primary-color': '#6200ea',
	            'primary-dark': '#3700b3',
	            'primary-light': '#f0e7fe',
	            'bg-white': '#ffffff',
	            'bg-light': '#f8f9fa',
	            'bg-lighter': '#f0f0f0',
	            'bg-toolbar': 'rgba(248, 248, 248, 0.621)',
	            'text-primary': '#333333',
	            'text-secondary': '#5f5f5f',
	            'text-white': '#ffffff',
	            'text-error': '#ff0000',
	            'border-color': '#cccccc',
	            'border-primary': '#6200ea',
	            'shadow-light': 'rgba(0, 0, 0, 0.1)',
	            'shadow-medium': 'rgba(0, 0, 0, 0.2)',
	            'shadow-focus': 'rgba(172, 113, 255, 0.75)',
	            'success-color': '#4CAF50',
	            'info-color': '#03A9F4',
	            'danger-color': '#dc3545',
	            'danger-dark': '#c82333',
	            'offline-bg': '#000040'
	        };
	    }

	    updateColor(variableName, value) {
	        this.root.style.setProperty(`--${variableName}`, value);
	        this.saveTheme();
	    }

	    updateTheme(colorObject) {
	        for (const [variable, value] of Object.entries(colorObject)) {
	            this.updateColor(variable, value);
	        }
	    }

	    getColor(variableName) {
	        return getComputedStyle(this.root).getPropertyValue(`--${variableName}`).trim();
	    }

	    saveTheme() {
	        const theme = Object.fromEntries(
	            Object.keys(this.def).map(variable => [variable, this.getColor(variable)])
	        );
	        localStorage.setItem('userTheme', JSON.stringify(theme));
	    }

	    loadTheme() {
	        const savedTheme = localStorage.getItem('userTheme');
	        if (savedTheme) {
	            this.def = JSON.parse(savedTheme);
	            this.updateTheme(this.def);
	        } else {
	            this.updateTheme(this.def);
	        }
	    }
	}

	const themeManager = new ThemeManager();

	function initializeColorPickers() {
	    const colorPickers = {
	        'primaryColor': 'primary-color',
	        'primaryDark': 'primary-dark',
	        'primaryLight': 'primary-light',
	        'bgWhite': 'bg-white',
	        'bgLight': 'bg-light',
	        'bgLighter': 'bg-lighter',
	        'bgToolbar': 'bg-toolbar',
	        'textPrimary': 'text-primary',
	        'textSecondary': 'text-secondary',
	        'textWhite': 'text-white',
	        'textError': 'text-error',
	        'borderColor': 'border-color',
	        'borderPrimary': 'border-primary',
	        'shadowLight': 'shadow-light',
	        'shadowMedium': 'shadow-medium',
	        'shadowFocus': 'shadow-focus',
	        'successColor': 'success-color',
	        'infoColor': 'info-color',
	        'dangerColor': 'danger-color',
	        'dangerDark': 'danger-dark',
	        'offlineBg': 'offline-bg'
	    };

	    for (const [id, variable] of Object.entries(colorPickers)) {
	        const picker = get(id);
	        if (picker) {
	            picker.value = themeManager.getColor(variable);
	            picker.addEventListener('input', (e) => {
	                themeManager.updateColor(variable, e.target.value);
	            });
	        }
	    }
	}

	function showSettingsModal() {
	    get('modalOverlay').style.display = 'block';
	    get('settingsModal').style.display = 'block';
	    initializeColorPickers();
	}

	function hideSettingsModal() {
	    get('modalOverlay').style.display = 'none';
	    get('settingsModal').style.display = 'none';
	}

	function resetTheme() {
	    themeManager.updateTheme(themeManager.def);
	    initializeColorPickers();
	}

	function applyTheme(themeName) {
	    const themes = {
	        dark: {
	            'primary-color': '#8e44ad',
	            'primary-dark': '#6c3483',
	            'primary-light': '#d2b4de',
	            'bg-white': '#373737',
	            'bg-light': '#1f1f1f',
	            'bg-lighter': '#4a4a4a',
	            'bg-toolbar': 'rgba(55, 55, 55, 0.621)',
	            'text-primary': '#ffffff',
	            'text-secondary': '#cccccc',
	            'text-white': '#ffffff',
	            'text-error': '#e74c3c',
	            'border-color': '#444444',
	            'border-primary': '#8e44ad',
	            'shadow-light': 'rgba(0, 0, 0, 0.1)',
	            'shadow-medium': 'rgba(0, 0, 0, 0.2)',
	            'shadow-focus': 'rgba(142, 68, 173, 0.75)',
	            'success-color': '#27ae60',
	            'info-color': '#3498db',
	            'danger-color': '#c0392b',
	            'danger-dark': '#a93226',
	            'offline-bg': '#000040'
	        },
	        light: {
	            'primary-color': '#2980b9',
	            'primary-dark': '#1c639c',
	            'primary-light': '#aed6f1',
	            'bg-white': '#ffffff',
	            'bg-light': '#f8f9fa',
	            'bg-lighter': '#f0f0f0',
	            'bg-toolbar': 'rgba(248, 248, 248, 0.621)',
	            'text-primary': '#333333',
	            'text-secondary': '#666666',
	            'text-white': '#ffffff',
	            'text-error': '#e74c3c',
	            'border-color': '#cccccc',
	            'border-primary': '#2980b9',
	            'shadow-light': 'rgba(0, 0, 0, 0.1)',
	            'shadow-medium': 'rgba(0, 0, 0, 0.2)',
	            'shadow-focus': 'rgba(41, 128, 185, 0.75)',
	            'success-color': '#27ae60',
	            'info-color': '#3498db',
	            'danger-color': '#c0392b',
	            'danger-dark': '#a93226',
	            'offline-bg': '#000040'
	        },
	        vibrant: {
	            'primary-color': '#ff6f61',
	            'primary-dark': '#c4443d',
	            'primary-light': '#ffa07a',
	            'bg-white': '#ffe5d8',
	            'bg-light': '#ffdac4',
	            'bg-lighter': '#fff0e1',
	            'bg-toolbar': 'rgba(255, 235, 205, 0.621)',
	            'text-primary': '#333333',
	            'text-secondary': '#666666',
	            'text-white': '#ffffff',
	            'text-error': '#e74c3c',
	            'border-color': '#ff7f50',
	            'border-primary': '#ff6f61',
	            'shadow-light': 'rgba(0, 0, 0, 0.1)',
	            'shadow-medium': 'rgba(0, 0, 0, 0.2)',
	            'shadow-focus': 'rgba(255, 111, 97, 0.75)',
	            'success-color': '#27ae60',
	            'info-color': '#3498db',
	            'danger-color': '#c0392b',
	            'danger-dark': '#a93226',
	            'offline-bg': '#000040'
	        },
	        tropical: {
	            'primary-color': '#1abc9c',
	            'primary-dark': '#16a085',
	            'primary-light': '#48c9b0',
	            'bg-white': '#e8f8f5',
	            'bg-light': '#d1f2eb',
	            'bg-lighter': '#a3e4d7',
	            'bg-toolbar': 'rgba(232, 248, 245, 0.621)',
	            'text-primary': '#333333',
	            'text-secondary': '#666666',
	            'text-white': '#ffffff',
	            'text-error': '#e74c3c',
				'border-color': '#1abc9c',
				'border-primary': '#16a085',
				'shadow-light': 'rgba(0, 0, 0, 0.1)',
				'shadow-medium': 'rgba(0, 0, 0, 0.2)',
				'shadow-focus': 'rgba(26, 188, 156, 0.75)',
				'success-color': '#27ae60',
				'info-color': '#3498db',
				'danger-color': '#c0392b',
				'danger-dark': '#a93226',
				'offline-bg': '#000040'
			},
			rainbow: {
			    'primary-color': 'linear-gradient(90deg, #ee5151, #ffbd5b, #2fda16, #5eaeff)',
			    'primary-dark': 'linear-gradient(90deg, #de1616, #ffb111, #6db66d, #4aa5ff)',
			    'primary-light': 'linear-gradient(90deg, #ffe6e6, #ffecd9, #ffffe6, #e6ffe6, #e6f7ff, #f2e6ff)',
			    'bg-white': 'linear-gradient(180deg, #FFFFFF, #FFFAF0)',
			    'bg-light': 'linear-gradient(180deg, #bfffff, #ffeeca)',
			    'bg-lighter': 'linear-gradient(180deg, #caffca, #ffd0df)',
			    'bg-toolbar': 'linear-gradient(90deg, rgba(194, 251, 185, 0.6), rgba(150, 211, 224, 0.6))',
			    'text-primary': '#333333',
			    'text-secondary': '#7b7b7b',
			    'text-white': '#FFFFFF',
			    'text-error': '#E74C3C',
			    'border-color': '#fd8484',
			    'border-primary': '#ff0d0d',
			    'shadow-light': 'rgba(0, 0, 0, 0.15)',
			    'shadow-medium': 'rgba(0, 0, 0, 0.25)',
			    'shadow-focus': 'rgba(225, 108, 30, 0.75)',
			    'success-color': 'linear-gradient(90deg, #00e300, #49a94f)',
			    'info-color': 'linear-gradient(90deg, #66b2ff, #198bd1)',
			    'danger-color': 'linear-gradient(90deg, #ff6666, #e60000)',
			    'danger-dark': 'linear-gradient(90deg, #ec0000, #ec0000)',
			    'offline-bg': 'linear-gradient(180deg, #000040, #000080)'
			},
			dark_rainbow: {
			    "primary-color": "linear-gradient(90deg, #cc3333, #cc8833, #338833, #3366cc)",
			    "primary-dark": "linear-gradient(90deg, #993333, #996633, #336633, #335599)",
			    "primary-light": "linear-gradient(90deg, #ffcccc, #ffe6cc, #e6ffe6, #ccffe6, #cceeff, #e6ccff)",
			    "bg-white": "linear-gradient(180deg, #f7f7f7, #fff5e6)",
			    "bg-light": "linear-gradient(180deg, #cce6cc, #ffedcc)",
			    "bg-lighter": "linear-gradient(180deg, #d9ffcc, #ffcccc)",
			    "bg-toolbar": "linear-gradient(90deg, rgba(174, 221, 160, 0.3), rgba(130, 188, 205, 0.3))",
			    "text-primary": "#222222",
			    "text-secondary": "#5c5c5c",
			    "text-white": "#FFFFFF",
			    "text-error": "#bf5a50",
			    "border-color": "#ff8282",
			    "border-primary": "#ff3333",
			    "shadow-light": "rgba(0, 0, 0, 0.20)",
			    "shadow-medium": "rgba(0, 0, 0, 0.35)",
			    "shadow-focus": "rgba(200, 72, 30, 0.75)",
			    "success-color": "linear-gradient(90deg, #55cc55, #89b788)",
			    "info-color": "linear-gradient(90deg, #76a6d9, #4d8acc)",
			    "danger-color": "linear-gradient(90deg, #cc6666, #cc0000)",
			    "danger-dark": "linear-gradient(90deg, #cc0000, #cc0000)",
			    "offline-bg": "linear-gradient(180deg, #2b2b5e, #5e5e8f)"
			 },
			default: {
				'primary-color': '#6200ea',
	            'primary-dark': '#3700b3',
	            'primary-light': '#f0e7fe',
	            'bg-white': '#ffffff',
	            'bg-light': '#f8f9fa',
	            'bg-lighter': '#f0f0f0',
	            'bg-toolbar': 'rgba(248, 248, 248, 0.621)',
	            'text-primary': '#333333',
	            'text-secondary': '#666666',
	            'text-white': '#ffffff',
	            'text-error': '#ff0000',
	            'border-color': '#cccccc',
	            'border-primary': '#6200ea',
	            'shadow-light': 'rgba(0, 0, 0, 0.1)',
	            'shadow-medium': 'rgba(0, 0, 0, 0.2)',
	            'shadow-focus': 'rgba(172, 113, 255, 0.75)',
	            'success-color': '#4CAF50',
	            'info-color': '#03A9F4',
	            'danger-color': '#dc3545',
	            'danger-dark': '#c82333',
	            'offline-bg': '#000040'
			}
	    };

    themeManager.updateTheme(themes[themeName]);
    initializeColorPickers();
}
	
	function toggleDropdown(element) {
	    let parent = element.closest('.color-category');
	    parent.classList.toggle('active');
	}

	get('settings').onclick = showSettingsModal;

	/* Load saved theme */
	document.addEventListener('DOMContentLoaded', () => {
	    themeManager.loadTheme();
	});

		/* Text Editing */
	    function changeFont(font) {
	      document.execCommand('fontName', false, font);
	      lastFont = font;
	    }

		function changeFontSize(increase) {
		    const selection = window.getSelection();
		    if (!selection.rangeCount) return;

		    const range = selection.getRangeAt(0);
		    const parentNode = range.commonAncestorContainer;
		    let span;

		    if (parentNode.nodeName === 'SPAN' || (parentNode.parentNode && parentNode.parentNode.nodeName === 'SPAN')) {
		        span = parentNode.nodeName === 'SPAN' ? parentNode : parentNode.parentNode;
		    } else {
		        span = document.createElement('span');
		        range.surroundContents(span);
		    }

		    let currentFontSize = parseInt(window.getComputedStyle(span).fontSize) || 16;
		    let newFontSize = increase ? currentFontSize + 1 : currentFontSize - 1;
		    newFontSize = Math.min(Math.max(newFontSize, 7), 140);
		    span.style.fontSize = newFontSize + 'px';

		    selection.removeAllRanges();
		    const newRange = document.createRange();
		    newRange.selectNodeContents(span);
		    selection.addRange(newRange);
		}

		function incFontSize() {
		    changeFontSize(true);
		}

		function decFontSize() {
		    changeFontSize(false);
		}

	    function changeAlignment(alignment) {
	      document.execCommand(alignment, false, null);
	      lastAlignment = alignment;
	      get('alignSelect').value = "";
	    }

	get('editor').addEventListener('click', function(event) {
	  const textToolbar = get('textToolbar');
	  const drawingToolbar = get('drawingToolbar');
	  const drawingCanvas = get('drawingCanvas');

	  if (event.target.tagName === 'IMG') {
	    selectedImage = event.target;
	    wrapImage(selectedImage);
	    textToolbar.classList.add('hide');
	    drawingToolbar.classList.add('hide');
	    drawingCanvas.classList.add('hide');
	  } else {
	    textToolbar.classList.remove('hide');
	    drawingToolbar.classList.add('hide');
	    drawingCanvas.classList.add('hide');
	    if (selectedImage) unwrapImage(selectedImage);
	    selectedImage = null;
	  }
	});
	let strokes = [];
	let currentStroke = [];

	function toggleDrawingToolbar() {
	    const drawingToolbar = get('drawingToolbar');
	    const drawingCanvas = get('drawingCanvas');
	    const textToolbar = get('textToolbar');

	    drawingToolbar.classList.toggle('hide');
	    textToolbar.classList.toggle('hide', !drawingToolbar.classList.contains('hide'));

	    if (!drawingToolbar.classList.contains('hide')) {
	        drawingCanvas.style.display = 'block';
	        drawingCanvas.style.zIndex = '6';
	        context = drawingCanvas.getContext('2d');

	        /* Render saved drawing if it exists */
	        if (savedDrawingData) {
	            const savedImage = new Image();
	            savedImage.src = savedDrawingData;
	            savedImage.onload = () => context.drawImage(savedImage, 0, 0);
	        }
	    } else {
	        drawingCanvas.style.display = 'none';
	    }
	}

	function saveAndHideDrawingToolbar() {
	    const drawingCanvas = get('drawingCanvas');
	    const drawingToolbar = get('drawingToolbar');
	    const textToolbar = get('textToolbar');

	    if (drawingCanvas) {
	        savedDrawingData = drawingCanvas.toDataURL();
	    }

	    /* Keep canvas behind text */
	    drawingCanvas.style.zIndex = '0';
	    textToolbar.classList.remove('hide');
	    drawingToolbar.classList.add('hide');
	}

	function setInkThickness(thickness) {
	    context.lineWidth = thickness;
	}

	function selectPenColor() {
	    context.lineWidth = 5;
	    context.globalCompositeOperation = 'source-over';
	    context.strokeStyle = get('penColor').value;
	}

	function selectHighlighter(color) {
	    context.lineWidth = 10;
	    context.strokeStyle = get('penColor').value;
	}

	function selectEraser() {
	    context.globalCompositeOperation = 'destination-out';
	    context.lineWidth = 30; /* Eraser thickness */

	    /* Erase strokes */
	    drawingCanvas.addEventListener('mousedown', function(event) {
	        const pos = getMousePos(event);
	        strokes = strokes.filter(stroke => {
	            const isErased = stroke.some(point => {
	                return Math.abs(point.x - pos.x) < context.lineWidth && Math.abs(point.y - pos.y) < context.lineWidth;
	            });
	            return !isErased;
	        });
	    });
	}

	document.addEventListener('DOMContentLoaded', () => {
	    const canvas = get('drawingCanvas');
	    context = canvas.getContext('2d');
	});

	get('drawingCanvas').addEventListener('mousedown', startDrawing);
	get('drawingCanvas').addEventListener('touchstart', startDrawing);

	get('drawingCanvas').addEventListener('mousemove', draw);
	get('drawingCanvas').addEventListener('touchmove', draw);

	get('drawingCanvas').addEventListener('mouseup', stopDrawing);
	get('drawingCanvas').addEventListener('touchend', stopDrawing);

	get('drawingCanvas').addEventListener('mouseout', stopDrawing);
	get('drawingCanvas').addEventListener('touchcancel', stopDrawing);

	function getMousePos(event) {
	    const rect = drawingCanvas.getBoundingClientRect();
	    return {
	        x: event.clientX - rect.left,
	        y: event.clientY - rect.top
	    };
	}

	function drawLine(context, x1, y1, x2, y2) {
	    context.beginPath();
	    context.moveTo(x1, y1);
	    context.lineTo(x2, y2);
	    context.stroke();
	    context.closePath();
	}

	function startDrawing(event) {
	    isDrawing = true;
	    const pos = getMousePos(event);
	    x = pos.x;
	    y = pos.y;
	    currentStroke = [{x, y}];
	}

	function draw(event) {
	    event.preventDefault();
	    if (isDrawing === true) {
	        const pos = getMousePos(event);
	        drawLine(context, x, y, pos.x, pos.y);
	        x = pos.x;
	        y = pos.y;
	        currentStroke.push({x, y});
	    }
	}

	function stopDrawing() {
	    if (isDrawing === true) {
	        isDrawing = false;
	        strokes.push(currentStroke);
	        context.globalCompositeOperation = 'source-over';
	    }
	}

	let selectedCell = null;

	document.addEventListener('click', function(event) {
	  if (event.target.tagName === 'TD' || event.target.tagName === 'TH') {
	    selectedCell = event.target;
	    showTableToolbar();
	  } else if (!event.target.closest('.toolbar')) {
	    showToolbar('textToolbar');
	  }
	});


	  function showTableToolbar() {
	  const tableToolbar = get('tableToolbar');
	  const textToolbar = get('textToolbar');
	  const drawingToolbar = get('drawingToolbar');
	  const drawingCanvas = get('drawingCanvas');

	  tableToolbar.classList.remove('hide');
	  textToolbar.classList.add('hide');
	  if (drawingToolbar) drawingToolbar.classList.add('hide');
	  if (drawingCanvas) drawingCanvas.style.display = 'none';
	}



	function addRow() {
	  if (selectedCell) {
	    const row = selectedCell.parentElement.cloneNode(true);
	    selectedCell.parentElement.parentElement.appendChild(row);
	  }
	}

	function addColumn() {
	  if (selectedCell) {
	    const rows = selectedCell.parentElement.parentElement.rows;
	    for (let i = 0; i < rows.length; i++) {
	      rows[i].insertCell(selectedCell.cellIndex + 1).innerHTML = "";
	    }
	  }
	}

	function deleteRow() {
	  if (selectedCell) {
	    selectedCell.parentElement.remove();
	  }
	}

	function deleteColumn() {
	  if (selectedCell) {
	    const rows = selectedCell.parentElement.parentElement.rows;
	    for (let i = 0; i < rows.length; i++) {
	      rows[i].deleteCell(selectedCell.cellIndex);
	    }
	  }
	}

	async function mergeCells() {
	  if (selectedCell) {
	    const span = parseInt(await prompts("Enter colspan or rowspan value:", "2"));
	    if (span) {
	      selectedCell.colSpan = span;
	    }
	  }
	}

	function splitCell() {
	  if (selectedCell && selectedCell.colSpan > 1) {
	    selectedCell.colSpan = 1;
	  }
	}

	function setCellType(type) {
	  if (selectedCell) {
	    const cellType = document.createElement(type);
	    cellType.innerHTML = selectedCell.innerHTML;
	    selectedCell.parentElement.replaceChild(cellType, selectedCell);
	    selectedCell = cellType;
	  }
	}

	function setAlignment(alignment) {
	  if (selectedCell) {
	    selectedCell.style.textAlign = alignment;
	  }
	}

	function toggleTableToolbar() {
	  const tableToolbar = get('tableToolbar');
	  const textToolbar = get('textToolbar');
	  if (tableToolbar.classList.contains('hide')) {
	    tableToolbar.classList.remove('hide');
	    textToolbar.classList.add('hide');
	  } else {
	    tableToolbar.classList.add('hide');
	    textToolbar.classList.remove('hide');
	  }
	}

	function showToolbar(toolbarId) {
	  const toolbars = document.querySelectorAll('.toolbar');
	  toolbars.forEach(toolbar => {
	    if (toolbar.id === toolbarId) {
	      toolbar.classList.remove('hide');
	    } else {
	      toolbar.classList.add('hide');
	    }
	  });
	}

	function toggleTextToolbar() {
	  showToolbar('textToolbar');

	  const editor = get('editor');
	  const br = document.createElement('br');
	  editor.appendChild(br);
	}

	   function getMousePos(event) {
	      const rect = drawingCanvas.getBoundingClientRect();
	      const clientX = event.clientX || event.touches[0].clientX;
	      const clientY = event.clientY || event.touches[0].clientY;
	      return {
	        x: clientX - rect.left,
	        y: clientY - rect.top
	      };
	    }
	    
	    function drawLine(context, x1, y1, x2, y2) {
	      context.beginPath();
	      context.lineWidth = context.lineWidth;
	      context.moveTo(x1, y1);
	      context.lineTo(x2, y2);
	      context.stroke();
	      context.closePath();
	    }

	    function removeResizeHandles() {
	      const handles = document.querySelectorAll('.resize-handle');
	      handles.forEach(handle => handle.remove());
	    }

	    /* Ensure resize handles are removed when image is deselected */
	    get('editor').addEventListener('click', function(event) {
	      const textToolbar = get('textToolbar');
	      const drawingToolbar = get('drawingToolbar');
	      const drawingCanvas = get('drawingCanvas');

	      if (event.target.tagName !== 'IMG') {
	          removeResizeHandles();
	      }
	    });

	function loadImage(src) {
	  const img = new Image();
	  img.src = src;
	  img.onload = () => get('editor').appendChild(img);
	}

	   function wrapImage(image) {
	  if (!image.parentElement.classList.contains('resizable')) {
	    const wrapper = document.createElement('div');
	    wrapper.classList.add('resizable');
	    image.parentNode.insertBefore(wrapper, image);
	    wrapper.appendChild(image);
	    addResizeHandles(wrapper);
	  }
	}

	async function convertImageToBase64(url) {
	    return new Promise((resolve, reject) => {
	        const img = new Image();
	        img.crossOrigin = 'anonymous';
	        img.onload = () => {
	            try {
	                const canvas = document.createElement('canvas');
	                const ctx = canvas.getContext('2d');
	                canvas.width = img.width;
	                canvas.height = img.height;
	                ctx.drawImage(img, 0, 0);
	                resolve(canvas.toDataURL('image/png'));
	            } catch (err) {
	                reject(new Error('Failed to convert image: ' + err.message));
	            }
	        };
	        img.onerror = () => reject(new Error('Failed to load image'));
	        img.src = url;
	    });
	}

	function unwrapImage(image) {
	  const wrapper = image.parentElement;
	  if (wrapper.classList.contains('resizable')) {
	    wrapper.replaceWith(image);
	  }
	}

	function addResizeHandles(wrapper) {
	  const handles = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
	  handles.forEach(handle => {
	    const handleDiv = document.createElement('div');
	    handleDiv.classList.add('resize-handle', handle);
	    handleDiv.addEventListener('mousedown', initResize);
	    wrapper.appendChild(handleDiv);
	  });
	}

	function initResize(event) {
	  startX = event.clientX;
	  startY = event.clientY;
	  startWidth = parseInt(document.defaultView.getComputedStyle(selectedImage).width, 10);
	  startHeight = parseInt(document.defaultView.getComputedStyle(selectedImage).height, 10);
	  document.documentElement.addEventListener('mousemove', doResize);
	  document.documentElement.addEventListener('mouseup', stopResize);
	}

	function doResize(event) {
	  selectedImage.width = startWidth + event.clientX - startX;
	  selectedImage.height = startHeight + event.clientY - startY;
	}

	function stopResize() {
	  document.documentElement.removeEventListener('mousemove', doResize);
	  document.documentElement.removeEventListener('mouseup', stopResize);
	}

	const FILE_MARKERS = {
	    UNENCRYPTED_V2: "EBF_UNENCRYPTED_V2",
	    ENCRYPTED_V2: "EBF_ENCRYPTED_V2"
	};

	/* GitHub integration */

	async function saveToGithub(content, fileName) {
	    try {
	        let sha;

	        const response = await fetch(`https://api.github.com/repos/eselagas/app.files/contents/docs/${userId}/${fileName}`, {
	            method: 'PUT',
	            headers: {
	                'Authorization': 'Bearer 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',
	                'Accept': 'application/vnd.github.v3+json',
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify({
	                message: sha ? `Updated ${fileName}` : `Created ${fileName}`,
	                content: btoa(String.fromCharCode(...new Uint8Array(new TextEncoder().encode(content)))),
	                sha: sha
	            })
	        });

	        if (!response.ok) throw new Error('Failed to save to GitHub');
	        return true;
	    } catch (error) {
	        console.error('GitHub save failed:', error);
	        throw new Error('Failed to save to GitHub');
	    }
	}

	/* Event handlers for the UI integration */
	document.addEventListener('DOMContentLoaded', () => {
	    /* Save button handler */
	    get('save').onclick = (e) => {
	        e.preventDefault();
	        showSaveOptions();
	    };

	    /* Open button handler */
	    get('open').onclick = (e) => {
	        e.preventDefault();
	        showOpenFileModal();
	    };

	    /* File input change handler */
	    get('fileInput').onchange = async (event) => {
	    const file = event.target.files[0];
	    if (!file) return;

	    const reader = new FileReader();
	    reader.onload = async (e) => {
	        try {
	            await openFile({
	                fileContent: e.target.result,
	                editorElement: get('editor'),
	                canvasElement: get('drawingCanvas')
	            });
	            hideModal();
	        } catch (error) {
	            if (error.message === 'Invalid password') {
	                showPasswordModal("Enter Password to Open File", async (password) => {
	                    try {
	                        await openFile({
	                            fileContent: e.target.result,
	                            password,
	                            editorElement: get('editor'),
	                            canvasElement: get('drawingCanvas')
	                        });
	                        hideModal();
	                    } catch (innerError) {
	                        alert("Invalid password!");
	                        showPasswordModal("Enter Password to Open File", arguments.callee);
	                    }
	                });
	            } else {
	                alert('Failed to open file: ' + error.message);
	            }
	        }
	    };
	    reader.readAsText(file);
	};

	    document.addEventListener('keydown', (e) => {
	        if (e.key === 'Escape') {
	            hideModal();
	        }
	    });
	});

	let selectedSaveOptions = {
	    encryption: null,
	    saveLocation: null
	};

	/* Modal management */
	function showSaveOptions() {
	    selectedSaveOptions = { encryption: null, saveLocation: null };
	    document.querySelectorAll('.save-option').forEach(opt => {
	        opt.classList.remove('selected');
	    });
	    
	    if (!isConnected) { get('gh').style.display = 'none'; }
	    else { get('gh').style.display = 'block'; }
	    
	    get('modalOverlay').style.display = 'block';
	    get('saveOptionsModal').style.display = 'block';
	    get('passwordModal').style.display = 'none';
	    get('openFileModal').style.display = 'none';
	}

	function selectSaveOption(option) {
	    if (['encrypted', 'unencrypted'].includes(option)) {
	        selectedSaveOptions.encryption = option;
	        document.querySelectorAll('.save-options:first-of-type .save-option')
	            .forEach(opt => opt.classList.remove('selected'));
	        event.currentTarget.classList.add('selected');
	    } else {
	        event.currentTarget.classList.toggle('selected');
	        selectedSaveOptions.saveLocation += option;
	    }
	    
	}

	async function init_save() {
	    if (!selectedSaveOptions.encryption || !selectedSaveOptions.saveLocation) {
	        alert("Please select both encryption and save options");
	        return;
	    }

		if (!fileName) fileName = await prompts("Enter filename:", "Untitled Document");
		
		fileName = fileName.replace(/\//g, '\uFF0F');

	    try {
	        if (selectedSaveOptions.encryption === 'encrypted') {
	            /* Encryption */
	            showPasswordModal("Set Password for Encryption", async (password) => {
	                try {
	                    await saveFile({
	                        fileName,
	                        password,
	                        saveLocation: selectedSaveOptions.saveLocation,
	                        editorElement: get('editor'),
	                        drawingData: savedDrawingData
	                    });
	                    hideModal();
	                } catch (error) {
	                    alert('Failed to save file: ' + error.message);
	                }
	            });
	        } else {
	            /* No Encryption */
	            await saveFile({
	                fileName,
	                saveLocation: selectedSaveOptions.saveLocation,
	                editorElement: get('editor'),
	                drawingData: savedDrawingData
	            });
	            hideModal();
	        }
	    } catch (error) {
	        alert("Couldn't save the file, " + error.message);
	    }
	}

	async function showOpenFileModal() {
	    const filesList = get('savedFilesList');
	    filesList.innerHTML = '';

	    if (!isConnected) {
	        endSpinner();
	        get('savedFilesList').innerHTML = `<p style="text-align: center; color: #575757; margin-bottom: 8px;" title="Make sure you are connected to Wi-Fi">Ensure you are connected to see your files.</p>`;
	        showModal('openFileModal');
	        return;
	    }

	    try {
	        showLoadingSpinner();
	        const response = await fetch(`https://api.github.com/repos/eselagas/app.files/contents/docs/${userId}`, {
	            method: 'GET',
	            headers: {
	                'Authorization': 'Bearer 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',
	                'Accept': 'application/vnd.github.v3+json'
	            }
	        });

	        if (!response.ok) {
	            console.warn("GitHub didn't respond / no files uploaded");
	            endSpinner();
	            filesList.innerHTML = '';
	            get('savedFilesList').innerHTML = `<p style="text-align: center; color: #575757; margin-bottom: 8px;" title="Upload a file or open a local one">Please upload a file to see it here.</p>`;
	            showModal('openFileModal');
	            return;
	        }
	        
	        const githubFiles = await response.json();
	        githubFiles.forEach(file => {
	            const fileItem = document.createElement('div');
	            const ftitle = file.name.replace(/\uFF0F/g, '/');
	            fileItem.className = 'saved-file-item';
	            fileItem.innerHTML = `<span>${ftitle}</span><span class="delete-icon" title="Delete file">🗑️</span>`;
	            fileItem.title = `Open "${ftitle}"`;
	            fileItem.id = ftitle;
	            fileItem.onclick = (event) => {
	                if (event.target.classList.contains('delete-icon')) {
	                    deleteFile(file.path, fileItem.id, ftitle);
	                } else {
	                    openFile({
	                        fileName: file.name,
	                        userId: userId,
	                        editorElement: get('editor'),
	                        canvasElement: get('drawingCanvas')
	                    });
	                }
	            };
	            filesList.appendChild(fileItem);
	        });
	        endSpinner();

	    } catch (error) {
	        console.error('An error occurred:', error);
	        alert('An error occurred: ' + error.message);
	        endSpinner();
	    }

	    showModal('openFileModal');
	}

	async function deleteFile(filePath, id, name) {
	    let sha;

	    try {
	    	showLoadingSpinner();
	        const getResponse = await fetch(`https://api.github.com/repos/eselagas/app.files/contents/${filePath}`, {
	            method: 'GET',
	            headers: {
	                'Authorization': 'Bearer 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',
	                'Accept': 'application/vnd.github.v3+json'
	            }
	        });

	        if (!getResponse.ok) {
	            throw new Error('Failed to get the file sha');
	        }

	        const fileMetadata = await getResponse.json();
	        sha = fileMetadata.sha;

	        const deleteResponse = await fetch(`https://api.github.com/repos/eselagas/app.files/contents/${filePath}`, {
	            method: 'DELETE',
	            headers: {
	                'Authorization': 'Bearer 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',
	                'Accept': 'application/vnd.github.v3+json',
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify({
	                message: `Deleted file: ${filePath}`,
	                sha: sha
	            })
	        });

	        if (!deleteResponse.ok) {
	            throw new Error('Failed to delete the file from GitHub');
	        }
	        
	        const deletedElement = get(id);
	        deletedElement.innerHTML = `<i>Deletion in progress...</i>`;
	        deletedElement.title = `Deleting "${name}"`;
	        endSpinner();
	    } catch (error) {
	    	endSpinner();
	        console.error('An error occurred:', error);
	        alert('An error occurred: ' + error.message);
	    }
	}

	function showModal(modalId) {
	    get('modalOverlay').style.display = 'block';
	    get(modalId).style.display = 'block';
	    get('passwordModal').style.display = 'none';
	    get('saveOptionsModal').style.display = 'none';
	}
	
	function convertToDate(isoTimestamp) {
        const date = new Date(isoTimestamp);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

	let currentModalCallback = null;

	function showPasswordModal(title, callback) {
	    get('modalOverlay').style.display = 'block';
	    get('passwordModal').style.display = 'block';
	    get('saveOptionsModal').style.display = 'none';
	    get('openFileModal').style.display = 'none';
	    get('passwordModalTitle').textContent = title;
	    get('passwordInput').value = '';
	    const password = get('passwordInput');
	    password.addEventListener('keyup', (e) => {
	    	if (e.key === 'Enter') set_as_password();
	    });
	    currentModalCallback = callback;
	}

	function hideModal() {
	    get('modalOverlay').style.display = 'none';
	    get('passwordModal').style.display = 'none';
	    get('openFileModal').style.display = 'none';
	    get('saveOptionsModal').style.display = 'none';
	    
	    selectedSaveOptions = { encryption: null, saveLocation: null };
	    document.querySelectorAll('.save-option').forEach(opt => {
	        opt.classList.remove('selected');
	    });
	    
	    currentModalCallback = null;
	    endSpinner();
	}

	async function set_as_password() {
	    const password = get('passwordInput').value;
	    if (password && currentModalCallback) {
	        await currentModalCallback(password);
	    }
	}

	/* Save file */
	async function saveFile({
	    fileName,
	    password = null,
	    saveLocation,
	    editorElement,
	    drawingData = null
	}) {
	    try {
	        showLoadingSpinner();
	        const editorContent = editorElement.innerHTML;
	        const inkData = drawingData ? `<ink:${drawingData}>` : '';
	        
	        const imageData = await Promise.all(
	            Array.from(editorElement.querySelectorAll('img'))
	                .map(async (img) => {
	                    const base64 = img.src.startsWith('data:image') 
	                        ? img.src 
	                        : await new Promise(resolve => convertImageToBase64(img.src, resolve));
	                    return `<picture:${base64}>`;
	                })
	        ).then(images => images.join(''));

	        const content = `${editorContent}${inkData}${imageData}`;
	        
	        let fileData;
	        
	        if (password) {
	            const encryptedData = await encryptContent(content, password);
	            fileData = {
	                marker: FILE_MARKERS.ENCRYPTED_V2,
	                name: fileName,
	                data: {
	                    encrypted: Array.from(encryptedData.encrypted),
	                    salt: Array.from(encryptedData.salt),
	                    iv: Array.from(encryptedData.iv)
	                },
	                date: new Date().toISOString(),
	                encrypted: true
	            };
	        } else {
	            fileData = {
	                marker: FILE_MARKERS.UNENCRYPTED_V2,
	                name: fileName,
	                data: content,
	                date: new Date().toISOString(),
	                encrypted: false
	            };
	        }
			
			if (saveLocation.includes('github')) {
	        try {
	            await saveToGithub(JSON.stringify(fileData), fileName);
	        } catch (error) {
	            throw new Error('Failed to save to GitHub: ' + error.message);
	        	}
	    	}

	        if (saveLocation.includes('download')) {
	            const blob = new Blob([JSON.stringify(fileData)], { type: 'application/json' });
	            const url = URL.createObjectURL(blob);
	            const a = document.createElement('a');
	            a.href = url;
	            a.download = `${fileName}.ebf`;
	            a.click();
	            URL.revokeObjectURL(url);
	        }
	        endSpinner();
	        changeDocTitle(fileName);
	        document.querySelector('#editor').dataset.modified = 'false';
	        return { success: true };
	    } catch (error) {
	        console.error('Save failed:', error);
	        throw new Error('Failed to save the file');
	    }
	}

	/* Open file */
	async function openFile({
	    fileName = null,
	    password = null,
	    fileContent = null,
	    editorElement = get('editor'),
	    userId,
	    canvasElement = get('drawingCanvas')
	}) {
	    try {
	        showLoadingSpinner();
	        let fileData, content;

	        if (fileName) {	        	
	            /* GitHub File */
	            const response = await fetch(`https://api.github.com/repos/eselagas/app.files/contents/docs/${userId}/${fileName}`, {
	                method: 'GET',
	                headers: {
	                    'Authorization': 'Bearer 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',
	                    'Accept': 'application/vnd.github.v3+json',
	                    'Content-Type': 'application/json',
	                }
	            });
	            
	            if (!response.ok) {
	                throw new Error('Failed to fetch file from GitHub');
	            }
	            
	            fileName = fileName.replace(/\uFF0F/g, '/');
	            const githubData = await response.json();
	            fileContent = new TextDecoder().decode(new Uint8Array([...atob(githubData.content)].map(char => char.charCodeAt(0))));
	            fileData = JSON.parse(fileContent);
	            
	            if (fileData.marker === FILE_MARKERS.ENCRYPTED_V2) {
	                endSpinner();
	                return new Promise((resolve) => {
	                    showPasswordModal("Enter Password to Open File", async (enteredPassword) => {
	                        try {
	                            showLoadingSpinner();
	                            content = await decryptContent(fileData.data, enteredPassword);
	                            resolve(processFileContent(content, editorElement, canvasElement));
	                            endSpinner();
	                        } catch (error) {
	                            alert("Invalid password, try again.");
	                            resolve({ success: false, error: "Invalid password" });
	                        }
	                        hideModal();
	                        changeDocTitle(fileName);
	                    });
	                });
	            } else {
	                content = fileData.data;
	                hideModal();
	                changeDocTitle(fileName);
	            }
	        } else {
	            /* Local File */
	            function parseFileContent(fileContent) { /* for legacy files */
				    try {
				        return JSON.parse(fileContent);
				    } catch (e) {
				        return { name: "Legacy File", data: fileContent, marker: "FILE_MARKERS.UNENCRYPTED_V2", password: null };
				    }
				}

				fileData = parseFileContent(fileContent);

				if (fileData.marker === FILE_MARKERS.ENCRYPTED_V2) {
				    endSpinner();
				    return new Promise((resolve) => {
				        showPasswordModal("Enter Password to Open File", async (enteredPassword) => {
				            try {
				                showLoadingSpinner();
				                content = await decryptContent(fileData.data, enteredPassword);
				                resolve(processFileContent(content, editorElement, canvasElement));
				                endSpinner();
				            } catch (error) {
				                alert("Invalid password, try again.");
				                resolve({ success: false, error: "Invalid password" });
				            }
				            hideModal();
				            get('doc-title').textContent = fileData.name;
				        });
				    });
				} else {
				    content = fileData.data;
				    document.title = `${fileData.name} - EBF Editor`;
				    get('doc-title').textContent = fileData.name;
				}
	        } 
			
			document.querySelector('#editor').dataset.modified = 'false';
	        return processFileContent(content, editorElement, canvasElement);
	    } catch (error) {
	        console.error('Open failed:', error);
	        endSpinner();
	        throw new Error(error.message || 'Failed to open the file');
	    }
	}

	function processFileContent(content, editorElement, canvasElement) {
	    /* Convert to string */
	    content = typeof content === 'string' ? content : JSON.stringify(content);

	    /* Handle drawing data */
	    if (canvasElement) {
	        const inkDataMatch = content.match(/<ink:([^>]*)>/);
	        if (inkDataMatch) {
	            const drawingData = inkDataMatch[1];
	            const context = canvasElement.getContext('2d');
	            const savedImage = new Image();
	            savedImage.src = drawingData;
	            savedImage.onload = () => {
	                canvasElement.style.display = 'block';
	                canvasElement.style.zIndex = '0';
	                context.drawImage(savedImage, 0, 0);
	            };
	        }
	    }

	    /* Clean and set content */
	    const cleanContent = content
	        .replace(/<ink:.*>/, '')
	        .replace(/<picture:[^>]*>/g, '');
	    editorElement.innerHTML = cleanContent;
	    endSpinner();
	    return {
	        success: true,
	        isEncrypted: content.marker === FILE_MARKERS.ENCRYPTED_V2
	    };
	}

	/* Helper functions for encryption / decryption */
	async function encryptContent(content, password) {
	    const encoder = new TextEncoder();
	    const data = encoder.encode(content);
	    const passwordKey = await crypto.subtle.importKey(
	        'raw',
	        encoder.encode(password),
	        { name: 'PBKDF2' },
	        false,
	        ['deriveBits', 'deriveKey']
	    );

	    const salt = crypto.getRandomValues(new Uint8Array(16));
	    const iv = crypto.getRandomValues(new Uint8Array(12));

	    const key = await crypto.subtle.deriveKey(
	        {
	            name: 'PBKDF2',
	            salt: salt,
	            iterations: 100000,
	            hash: 'SHA-256'
	        },
	        passwordKey,
	        { name: 'AES-GCM', length: 256 },
	        false,
	        ['encrypt']
	    );

	    const encrypted = await crypto.subtle.encrypt(
	        { name: 'AES-GCM', iv: iv },
	        key,
	        data
	    );

	    return {
	        encrypted: new Uint8Array(encrypted),
	        salt: salt,
	        iv: iv
	    };
	}

	async function decryptContent(encryptedData, password) {
	    const encoder = new TextEncoder();
	    const passwordKey = await crypto.subtle.importKey(
	        'raw',
	        encoder.encode(password),
	        { name: 'PBKDF2' },
	        false,
	        ['deriveBits', 'deriveKey']
	    );
	    
	    const key = await crypto.subtle.deriveKey(
	        {
	            name: 'PBKDF2',
	            salt: new Uint8Array(encryptedData.salt),
	            iterations: 100000,
	            hash: 'SHA-256'
	        },
	        passwordKey,
	        { name: 'AES-GCM', length: 256 },
	        false,
	        ['decrypt']
	    );
	    
	    try {
	        const decrypted = await crypto.subtle.decrypt(
	            { name: 'AES-GCM', iv: new Uint8Array(encryptedData.iv) },
	            key,
	            new Uint8Array(encryptedData.encrypted)
	        );
	        
	        return new TextDecoder().decode(decrypted);
	    } catch (error) {
	        throw new Error('Invalid password');
	    }
	}
	
	/* Connection Status */
	window.addEventListener('online', () => {
        get('wifi-status').style.display = 'none';
        console.log('Back online!');
    	isConnected = true;
    	updateFontOptions();
    	updateImageAttributes();
    });

    window.addEventListener('offline', () => {
        get('wifi-status').style.display = 'block';
        console.warn('No internet connection.');
        isConnected = false;
        updateFontOptions();
    });

	function isContentModified() {
		const element = document.querySelector('#editor');
	    return element.dataset.modified === 'true';
	}

	function resetModS() {
	    document.querySelector('#editor').dataset.modified = 'false';
	    document.title = document.title.substring(1);
	}

	window.addEventListener('beforeunload', (event) => {
	    if (isContentModified()) {
	        const confirmationMessage = 'You have unsaved changes. Are you sure you want to leave?';
	        event.returnValue = confirmationMessage;
	        return confirmationMessage;
	    }
	});

	const element = document.querySelector('#editor');
	element.addEventListener('input', () => {
        if (element.dataset.modified != 'true') {
        	document.title = `*${document.title}`;
        	element.dataset.modified = 'true';
        } else if (element.textContent === '') {
        	resetModS();
        } else return;
    });
    
    function get(item) {
	    const element = document.getElementById(item);
	    if (!element) {
	        console.error(`Element ID ${item} not found.`);
	        return null;
	    }
	    return element;
	}
	
	
	window.addEventListener('load', () => {
      get('editor').focus();
    });

</script>
</body>
</html>
